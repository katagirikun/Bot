import telebot
import random

# âœ… Bot Token
TOKEN = "7002972622:AAHqC1F1ErSqRLu5Mlpq-g-pZc9nAWcglPM"
bot = telebot.TeleBot(TOKEN)

# ğŸ”¥ Points Dictionary (Reset on Bot Restart)
user_points = {}

# ğŸ¯ Allowed Group Name
ALLOWED_GROUP_TITLE = "ğ—–ğ—¥ğ—¢ğ—­ğ—¡ ğ—« ğ—¦ğ—ğ—œğ—¡ğ—¦ CHAT"

# ğŸ“¢ Group Invite Link
INVITE_LINK = "https://t.me/+Gf__3xcNl4sxYWFl"

# âš ï¸ Admin IDs (Only these users can generate codes)
ADMIN_IDS = [123456789, 987654321]  # Replace with actual admin user IDs

# ğŸ”‘ Codes Dictionary (Stores codes that can be redeemed)
redeem_codes = {}  # key: code, value: user_id who redeemed it

# ğŸ“œ Help Menu
@bot.message_handler(commands=['all'])
def all_commands(message):
    bot.reply_to(message, """ğŸ“œ **Commands List**  
ğŸ® *Game Features:*  
- ğŸ† `/leaderboard` - See top players  
- ğŸ“Š `/points` - Check your score  
- ğŸ”„ `/sendpoints @username amount` - Send points  
- ğŸ° `/bet amount` - Gamble your points (10% chance)  
- ğŸ® `/redeem code` - Redeem a code if you have one  
- ğŸ“œ `/all` - Show this command list  
      
ğŸ† **Compete, Earn, & Win Rewards!** ğŸš€""", parse_mode="Markdown")

# âš ï¸ Start Command
@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, f"""âš ï¸ **Warning:**  
ğŸš€ *Bot restart hone par saare points reset ho jayenge!*
  
ğŸ‰ **Welcome to the Giveaway!**  
ğŸ”¹ **Earn Points:**  
   ğŸ’¬ *Send messages in* [this group]({INVITE_LINK}) *to earn* `+1` *point per message!*  
   ğŸ”— *Invite new users and get* `+20` *points!*  

ğŸ® **Game Commands:**  
ğŸ† `/leaderboard` - See the top players  
ğŸ“Š `/points` - Check your score  
ğŸ”„ `/sendpoints @user amount` - Send points to a friend  
ğŸ° `/bet amount` - Gamble your points! (10% win rate)  
ğŸ“œ `/all` - Show all available commands  

ğŸ”¥ **Good luck! May the best player win!**  
""", parse_mode="Markdown")

# ğŸ”¥ Message Karne Par 1 Point
@bot.message_handler(func=lambda message: message.chat.title == ALLOWED_GROUP_TITLE)
def give_point(message):
    user_id = message.from_user.id
    username = message.from_user.username or message.from_user.first_name

    if user_id in user_points:
        user_points[user_id]["points"] += 1
    else:
        user_points[user_id] = {"username": username, "points": 1}

# ğŸ“Š Check Your Score
@bot.message_handler(commands=['points'])
def check_points(message):
    user_id = message.from_user.id
    if user_id in user_points:
        bot.reply_to(message, f"ğŸ“Š **Your Total Points:** `{user_points[user_id]['points']} ğŸ…`", parse_mode="Markdown")
    else:
        bot.reply_to(message, "âŒ You have no points yet! Start chatting in the group to earn points.")

# ğŸ† Leaderboard
@bot.message_handler(commands=['leaderboard'])
def leaderboard(message):
    if not user_points:
        bot.reply_to(message, "âŒ No users in the leaderboard yet!")
        return

    sorted_users = sorted(user_points.items(), key=lambda x: x[1]['points'], reverse=True)[:5]
    medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"]

    leaderboard_text = "ğŸ† **Leaderboard** ğŸ†\n\n"
    for i, (user_id, user) in enumerate(sorted_users):
        leaderboard_text += f"{medals[i]} @{user['username']} - `{user['points']} points`\n"

    bot.reply_to(message, leaderboard_text, parse_mode="Markdown")

# ğŸ”„ Send Points
@bot.message_handler(commands=['sendpoints'])
def send_points(message):
    args = message.text.split()
    if len(args) != 3:
        bot.reply_to(message, "âŒ Format: `/sendpoints @username amount`", parse_mode="Markdown")
        return

    sender_id = message.from_user.id
    sender_username = message.from_user.username or message.from_user.first_name
    receiver_username = args[1].replace("@", "")
    try:
        amount = int(args[2])
    except ValueError:
        bot.reply_to(message, "âŒ Please enter a valid number.")
        return

    if sender_id not in user_points or user_points[sender_id]["points"] < amount:
        bot.reply_to(message, "âŒ You don't have enough points!")
        return

    # ğŸŸ¢ Find Receiver ID
    receiver_id = None
    for user_id, data in user_points.items():
        if data["username"] == receiver_username:
            receiver_id = user_id
            break

    if receiver_id is None:
        bot.reply_to(message, "âŒ User not found in the system!")
        return

    # âœ… Transfer Points
    user_points[sender_id]["points"] -= amount
    user_points[receiver_id]["points"] += amount

    bot.reply_to(message, f"âœ… **{amount} points sent to @{receiver_username}!** ğŸ‰", parse_mode="Markdown")

# ğŸ° Gambling Feature (10% Win Rate)
@bot.message_handler(commands=['bet'])
def gamble(message):
    args = message.text.split()
    if len(args) != 2:
        bot.reply_to(message, "âŒ Format: `/bet amount`", parse_mode="Markdown")
        return

    user_id = message.from_user.id
    if user_id not in user_points:
        bot.reply_to(message, "âŒ You have no points to bet!")
        return

    try:
        bet_amount = int(args[1])
    except ValueError:
        bot.reply_to(message, "âŒ Please enter a valid number.")
        return

    if bet_amount < 5:
        bot.reply_to(message, "âŒ Minimum bet amount is **5 points**!", parse_mode="Markdown")
        return

    if user_points[user_id]["points"] < bet_amount:
        bot.reply_to(message, "âŒ You don't have enough points to bet!")
        return

    # ğŸƒ **10% Chance to Win**
    if random.randint(1, 10) == 1:  # 10% probability
        # âœ… **Win: Double the bet amount**
        user_points[user_id]["points"] += bet_amount
        bot.reply_to(message, f"ğŸ‰ **Congratulations!** ğŸ° You won **{bet_amount} points**! ğŸ†\n\nğŸ“Š **New Balance:** `{user_points[user_id]['points']} points`", parse_mode="Markdown")
    else:
        # âŒ **Loss: Lose the bet amount**
        user_points[user_id]["points"] -= bet_amount
        bot.reply_to(message, f"ğŸ˜¢ **You lost {bet_amount} points!**\n\nğŸ’€ Better luck next time! ğŸ€\n\nğŸ“Š **New Balance:** `{user_points[user_id]['points']} points`", parse_mode="Markdown")

# ğŸ”‘ Admin Generate Redeem Code
@bot.message_handler(commands=['generatecode'])
def generate_code(message):
    if message.from_user.id not in ADMIN_IDS:
        bot.reply_to(message, "âŒ Only admins can generate codes!")
        return

    code = str(random.randint(100000, 999999))  # Generate a random 6-digit code
    redeem_codes[code] = None  # Code is initially available to be redeemed by any user

    bot.reply_to(message, f"âœ… **Code Generated!**\nUse the code `{code}` to redeem points.")

# ğŸ Redeem Code
@bot.message_handler(commands=['redeem'])
def redeem_code(message):
    args = message.text.split()
    if len(args) != 2:
        bot.reply_to(message, "âŒ Format: `/redeem code`", parse_mode="Markdown")
        return

    code = args[1]
    user_id = message.from_user.id
    if code not in redeem_codes:
        bot.reply_to(message, "âŒ This code is invalid or expired.")
        return

    if redeem_codes[code] is not None:
        bot.reply_to(message, "âŒ This code has already been redeemed.")
        return

    # Redeem the code
    redeem_codes[code] = user_id
    if user_id in user_points:
        user_points[user_id]["points"] += 50  # Give 50 points as a reward
    else:
        user_points[user_id] = {"username": message.from_user.username or message.from_user.first_name, "points": 50}

    bot.reply_to(message, f"ğŸ‰ **Code Redeemed Successfully!**\nYou have received `50 points`! ğŸŠ")

# âœ… Bot Start
if __name__ == "__main__":
    print("ğŸ¤– Bot is Running...")
    bot.polling()
